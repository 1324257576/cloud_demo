###### SQL查询语句执行流程：

A 客户端请求连接（连接器，负责与客户端建立连接、获取权限、维持和管理连接）

在使用中尽量使用长连接，减少建立连接的动作。

长连接导致内存占用的解决方案：

1. 定期断开长连接
2. 在执行过占用内存的大查询后，断开连接，待需要查询再重连
3. 在执行大操作后，通过执行mysql_reset_connection来重置状态为刚刚创建完的状态，重新初始化连接资源，这个过程不需要进行重连。

B 查询缓存

C 对`SQL`进行词法分析与语法分析（分析器）

D 进行索引的选择或者多表关联的表连接顺序的决定（优化器）

E 调用存储引擎API获取结果集（执行器）

InnoDB的数据是按数据页为单位来读写的。当需要读一条记录时，以页为单位，将整体的数据读入内存中。



###### SQL更新语句执行流程

`UPDATE T SET c=c+1 WHERE ID=2`

A：连接器

B：分析器，通过词法语法分析得知当前是更新语句

C：优化器，决定使用ID的索引

D：执行器：

1. 执行器首先去存储引擎查找该行,如果内存存在数据，直接返回给执行器,否则从磁盘中读入到内存中
2. 将行数据的c值+1，写入新行，使用新行更新到内存
3. 将更新操作记录到redo log中，redo log处于prepared状态，并告知执行器记录完成，随时可以提交事务
4. 执行器生成这个更新操作的`binlog`，写入到bin log buffer（最终写入磁盘bin log文件中），
5. 执行器通过调用引擎的提交事务接口，引擎将redo log状态改成commit状态，（先写在redo log buffer，最终写入磁盘redo log文件中）更新完成。

bin log：归档日志，记录语句的原始逻辑，可以追加方式写入磁盘文件。

redo log：`Innodb`存储引擎特有的，有crash-safe能力，保证事务的持久性

undo log: 回退日志，记录数据行被修改前的值，可以用于在事务失败时进行回滚，保证事务的原子性

` inoodb_flush_log_at_trx_commit  `参数设置为1，表示每次事务的redo log都持久化到磁盘中，可以保证异常重启后数据不丢失

`sync_binlog`参数设置为1，表示每次事务的`binlog`都持久化到磁盘，可以保证异常重启后`binlog`不丢失



###### 隔离性与隔离级别

SQL标准的事务隔离级别：

1. 读未提交：事务还没提交，它的变更就能被其他事务看到
2. 读已提交：事务提交后，它的变更才能被其他事务看到
3. 可重复读：一个事务在执行过程看到的数据，总是与这个事务刚启动时看到的数据是一致的
4. 串行化：对于同一行记录，写会加写锁，读会加读锁，当读写锁冲突时，后访问的事务需要等待前一个事务执行完成，才能继续执行

实现方式：数据库通过创建一致性读视图` consistent read view `，访问行数据的时候以视图的逻辑结果为准（支持读已提交和可重复读两个事务隔离级别）。在事务隔离级别下的对行数据的访问：

读未提交：直接返回记录上的最新值

读已提交：在每个SQL语句开始执行前创建视图，

可重复读：在事务启动时创建，整个事务期间都使用该视图

串行化：直接加锁避免并行访问







###### InnoDB存储引擎的索引

索引类型分为：

1. 主键索引：主键索引的叶子节点存储的是整行数据
2. 非主键索引：非主键索引的叶子节点存储的是主键值。如果使用非主键索引进行查询时，先在当前索引树上查出主键值，再回到主键索引上查出整行数据（这个过程成为回表）。

覆盖索引

如果查询字段在K索引树上，不需要进行回表，而直接返回查询结果，称为覆盖索引。

最左前缀原则



change buffer：适用于普通索引，用于在不影响数据一致性前提下，先缓存对二级索引的insert/update/delete等操作，而不需要从磁盘中读入数据页，再在一定情况下通过merge将change buffer的操作应用到原数据页。

使用前缀索引：`alter table tb_name add index(col_name(length))`

对身份证号码字段建立索引的优化思路：对身份证号码的值reverse倒序存储，或者增加列用于存储对值hash计算后的值，并对增加列建立索引

###### 行锁/表级锁

两阶段锁

在`InnoDB`事务中，行锁是在需要的时候才加上去的，但释放需要等到事务结束才释放。因此，如果事务中需要锁多个行，要把最可能造成锁冲突、最影响并发度的锁尽量放在靠后。





###### 主备一致

主库将数据更新操作写入到bin log，

1. 备库首先通过change master命令，设置主库连接信息以及请求读取的日志偏移量，
2. 然后通过执行start slave命令，启动IO_THREAD和SQL_THREAD线程，其中IO线程负责与主库进行建立连接，
3. 主库通过备库请求的日志偏移量，从本地读取bin log，返回备库
4. 备库拿到binlog后，写入中转日志relay log中。
5. SQL线程从relay_log中读取中转日志，解析并执行日志中的命令。



###### 快照读与当前读

普通select操作是快照读，读已提交级别下，每次select都会生成快照读；可重复读级别下，开启事务后的第一个select语句生成快照读。

当前读：对当前记录加锁，阻塞其他事务同时改动该记录，读取到的是最新版本的数据。

select lock in shared mode/select for update/insert/update/delete/以及串行化级别下的select



###### MVCC多版本并发控制

MVCC通过数据在某个时间点的快照来实现，一个事务无论执行多长时间，在同一个事务里能够看到数据一致的视图。

每行数据都存在对应的版本号，更新数据时需要比较版本号并更新版本号，如果成功则提交并覆盖原记录，如果失败则放弃此次改动。

